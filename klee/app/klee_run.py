import os
from subprocess import getstatusoutput, Popen, DEVNULL
from env import *
import time
import sys

get_timer = time.clock if sys.platform == "win32" else time.time

print(LIBC_REPLACE)

def gather_results():
    print("Gathering results")
    sources_dir = 'sources'
    results_dir = 'results'

    for subdir, _, _ in os.walk(sources_dir):
        klee_out_dir = os.path.join(subdir, 'klee-last')
        for _, _, files in os.walk(klee_out_dir):
            for file in files:
                if file.endswith(".err"):
                    filepath = os.path.join(klee_out_dir, file)
                    root, extension = os.path.splitext(filepath)
                    root, extension = os.path.splitext(root)
                    test_filepath = root + '.ktest'

                    ret, out = getstatusoutput(f"ktest-tool {test_filepath}")

                    if ret:
                        print(f"There was an issue getting the results for \
                                file {test_filepath}")
                    else:
                        result_name = os.path.basename(subdir) + file
                        result_filepath = os.path.join(results_dir, result_name) 
                        result_filepath, ext = os.path.splitext(result_filepath)
                        result_filepath, ext = os.path.splitext(result_filepath)
                        result_filepath += '.txt'

                        print(f"Generated err file: {result_filepath}")
                        with open(result_filepath, 'w') as f:
                            f.write(out)

    print()
    print()


def compile():
    print("Compiling the files")
    sources_dir = 'sources'

    for subdir, dirs, files in os.walk(sources_dir):
        for file in files:
            if file.endswith(".c"):
                filepath = os.path.join(subdir, file)
                print(f"Compiling {filepath}")
                root, extension = os.path.splitext(filepath)
                bc_filepath = root + '.bc'
                ret, out = getstatusoutput(f"clang -I ../../include \
                    -emit-llvm -c -g -O0 -Xclang \
                    -disable-O0-optnone {filepath} -o {bc_filepath}")
                if ret:
                    print(out)

    print()
    print()


def generate_klee_command(compiled_file):
    command = "klee"

    if POSIX_RUNTIME:
        command = command + f" {POSIX_RUNTIME}"
        
    if LIBC_REPLACE:
        command = command + f" {LIBC_REPLACE}"

    command = command + f" {compiled_file}"

    if SYM_ARGS:
        command = command + f" -sym-args {SYM_ARGS_MIN} {SYM_ARGS_MAX} {SYM_ARGS_SIZE}"

    if SYM_STDIN:
        command = command + f" -sym-stdin {SYM_STDIN_SIZE}"

    if SYM_FILES:
        command = command + f" -sym-files {SYM_FILES_NUM} {SYM_FILES_SIZE}"

    return command

def run_klee():
    print("Running klee on the files")
    sources_dir = 'sources'

    for subdir, dirs, files in os.walk(sources_dir):
        for file in files:
            if file.endswith(".bc"):
                filepath = os.path.join(subdir, file)
                command = generate_klee_command(filepath)
                print(f"Running command: {command}")

                process = Popen(
                        [command], 
                        shell=True,
                        stdout=DEVNULL,
                        stderr=DEVNULL)
                current_time = get_timer()
                while get_timer() < current_time + KLEE_RUN_TIMEOUT and process.poll() is None:
                    time.sleep(0.5)  # wait half a second, you can adjust the precision
                if process.poll() is None:  # timeout expired, if it's still running...
                    process.terminate()
                    print("Process terminated early")
                else:
                    print("Process finished successfully")

    print()
    print()


def cleanup():
    print("Running cleanup through sources")
    sources_dir = 'sources'
    results_dir = 'results'

    for subdir, dirs, files in os.walk(sources_dir):
        print(f"Cleaning {subdir}")
        ret, out = getstatusoutput(f"rm -rf {subdir}/klee-*")
        ret, out = getstatusoutput(f"rm -rf {subdir}/*.bc")

    print(f"Cleaning {results_dir}")
    ret, out = getstatusoutput(f"rm -rf {results_dir}/*")

    print()
    print()

def main():
    cleanup()
    #compile()
    #run_klee()
    #gather_results()

if __name__ == "__main__":
    main()
