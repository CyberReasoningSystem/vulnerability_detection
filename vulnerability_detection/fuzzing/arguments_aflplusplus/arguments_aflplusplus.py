import os
import shutil

from vulnerability_detection.fuzzing.abstract_aflplusplus import (
    AFLPlusPlus,
    SessionFolderStructure,
)
from vulnerability_detection.fuzzing.input_streams import InputStream

ADAPTER_PATH = "vulnerability_detection/fuzzing/arguments_aflplusplus/adapter/bin/adapter.elf"
ADAPTER_FILENAME = "adapter"


class ArgumentsAFLPlusPlus(AFLPlusPlus):
    __SUPPORTED_INPUT_STREAMS = [
        InputStream.ARGUMENTS,
    ]
    __format_string: str

    def __init__(self, format_string: str) -> None:
        super().__init__(self.__SUPPORTED_INPUT_STREAMS)

        self.__format_string = format_string

    def _create_additional_folder_structure(
        self, structure: SessionFolderStructure
    ) -> None:
        binary = os.path.join(structure.source_folder, ADAPTER_FILENAME)
        shutil.copyfile(ADAPTER_PATH, binary)

    def _get_fuzzing_command(self) -> None:
        return (
            "./afl-fuzz -i /target/sample_inputs -o /target/analysis -Q"
            f" /target/source/{ADAPTER_FILENAME} /target/source/binary"
            f' "{self.__format_string}"'
        )
