#!/usr/bin/env python3


import click
import hexdump
from rich import print  # pylint: disable=redefined-builtin

from commons.input_streams import InputStreams
from vulnerability_detection import ExposedVulnerabilityDetectors
from vulnerability_detection.fuzzing import BaseFuzzer, ProofOfVulnerability
from vulnerability_detection.pov_consumer import PoVConsumer


def convert_name_to_fuzzer(name: str) -> BaseFuzzer:
    configured_fuzzer = getattr(ExposedVulnerabilityDetectors, name).value

    fuzzer = configured_fuzzer()

    return fuzzer


class PrintPoVConsumer(PoVConsumer):
    def notify_new_pov(self, pov: ProofOfVulnerability) -> None:
        print(
            "New proof of vulnerability was generated with the following"
            " payloads:"
        )

        for payload in pov.payloads_per_streams:
            print(f"- For {payload.input_stream.name}:\n")
            hexdump.hexdump(payload.content)
            print("")


@click.group()
def cli() -> None:
    """Discovers vulnerabilities in executables."""


@cli.command(help="Find vulnerabilities by using a fuzzer.")
@click.option(
    "--fuzzer",
    type=click.Choice(
        [fuzzer.name for fuzzer in ExposedVulnerabilityDetectors]
    ),
    required=True,
    help="Used fuzzer",
)
@click.option(
    "--stream",
    type=click.Choice([stream.name for stream in InputStreams]),
    required=True,
    help="Input streams of the executable",
)
@click.option(
    "--elf",
    type=click.Path(exists=True),
    required=True,
    help="Executables to be fuzzed",
)
@click.option(
    "--samples",
    type=click.Path(exists=True),
    help="Folder containing samples",
)
@click.option(
    "--arguments",
    type=str,
    required=False,
    default="",
    help=(
        "Arguments to be passed. When fuzzing arguments, this is a format"
        " string."
    ),
)
def fuzz(
    fuzzer: str, stream: str, elf: str, samples: str, arguments: str
) -> None:
    stream = getattr(InputStreams, stream)
    fuzzer = convert_name_to_fuzzer(fuzzer)
    fuzzer.set_input_stream(stream)
    fuzzer.set_target(elf, samples, arguments)

    consumer = PrintPoVConsumer()
    fuzzer.attach_consumer(consumer)

    fuzzer.start_fuzzing()


def main() -> None:
    cli(prog_name="vulnerability_detection")


if __name__ == "__main__":
    main()
