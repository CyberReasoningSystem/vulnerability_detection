#!/usr/bin/env python3

from enum import Enum

import click

from vulnerability_detection.crash_core.crash import PrintCrashConsumer
from vulnerability_detection.fuzzing import (
    ArgumentsAFLPlusPlus,
    BaseFuzzer,
    FilesAFLPlusPlus,
    InputStream,
    StdinAFLPlusPlus,
)


class ConfiguredFuzzer:
    actual_class: BaseFuzzer
    used_input_stream: InputStream

    def __init__(
        self, actual_class: BaseFuzzer, used_input_stream: InputStream
    ) -> None:
        self.actual_class = actual_class
        self.used_input_stream = used_input_stream


class ExposedFuzzers(Enum):
    FILES_AFLPLUSPLUS = ConfiguredFuzzer(FilesAFLPlusPlus, InputStream.FILES)
    ARGS_AFLPLUSPLUS = ConfiguredFuzzer(
        ArgumentsAFLPlusPlus, InputStream.ARGUMENTS
    )
    STDIN_AFLPLUSPLUS = ConfiguredFuzzer(
        StdinAFLPlusPlus, InputStream.STANDARD_INPUT
    )


def convert_name_to_fuzzer(name: str, arguments_pattern: str) -> BaseFuzzer:
    configured_fuzzer = getattr(ExposedFuzzers, name).value

    fuzzer = configured_fuzzer.actual_class(arguments_pattern)
    fuzzer.set_input_stream(configured_fuzzer.used_input_stream)

    return fuzzer


@click.group()
def cli() -> None:
    """Discovers vulnerabilities in executables."""


@cli.command(help="Find vulnerabilities by using a fuzzer.")
@click.option(
    "--fuzzer",
    type=click.Choice([fuzzer.name for fuzzer in ExposedFuzzers]),
    required=True,
    help="Used fuzzer",
)
@click.option(
    "--elf",
    type=click.Path(exists=True),
    required=True,
    help="Executables to be fuzzed",
)
@click.option(
    "--samples",
    type=click.Path(exists=True),
    required=True,
    help="Folder containing samples",
)
@click.option(
    "--arguments",
    type=str,
    required=False,
    default="",
    help=(
        "Arguments to be passed. When fuzzing arguments, this is a format"
        " string."
    ),
)
def fuzz(fuzzer: str, elf: str, samples: str, arguments: str) -> None:
    fuzzer = convert_name_to_fuzzer(fuzzer, arguments)
    fuzzer.set_target(elf, samples)

    consumer = PrintCrashConsumer()
    fuzzer.attach_consumer(consumer)

    fuzzer.start_fuzzing()


def main() -> None:
    cli(prog_name="vulnerability_detection")


if __name__ == "__main__":
    main()
