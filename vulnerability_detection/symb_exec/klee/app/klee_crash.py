import re

from vulnerability_detection.crash_core.crash import Crash
from vulnerability_detection.crash_core.input_surface import InputSurface
from vulnerability_detection.crash_core.input_streams import InputStream


class KleeCrash(Crash):
    def intake_klee_result(self, file_path: str, source_path: str = ""):
        with open(file_path, "r") as f:
            out = f.read()
            # Regular expressions to match the 'name' and 'data' lines
            name_re = re.compile(r"object +\d+: name: '(.+)'")
            data_re = re.compile(r"object +\d+: data: (b'.+?')")

            # Lists to store the names and data
            names = []
            data = []

            # Go through each line in the output
            for line in out.split('\n'):
                # Try to match the 'name' line
                name_match = name_re.match(line)
                if name_match:
                    names.append(name_match.group(1))

                # Try to match the 'data' line
                data_match = data_re.match(line)
                if data_match:
                    # eval() is used to convert the string representation of bytes to actual bytes
                    data.append(eval(data_match.group(1)))

            # Zip the names and data together into a list of tuples
            result = list(zip(names, data))

            for input in result:
                name = input[0]
                if re.match(r"arg\d+", name):
                    stream = InputStream.ARGUMENTS
                elif re.match(r"[A-Z]-data-stat", name):
                    stream = InputStream.FILES
                elif name == "stdin-stat":
                    stream = InputStream.STANDARD_INPUT
                else:
                    continue
                self.add_input_surfaces(InputSurface(
                    payload=input[1],
                    stream=stream
                ))

            self.source_path = source_path





if __name__ == "__main__":
    klee_crash = KleeCrash()
    klee_crash.intake_klee_result("vulnerability_detection/symb_exec/klee/results/test2test000011.ptr.err.txt")
    # consumer = PrintCrashConsumer()
    # consumer.notify_new_crash(klee_crash)
